generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  username         String            @unique
  name             String?
  password         String
  avatar           String?
  mobile           String?
  postcode         String?
  profileCompleted Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  ownedComps       Competition[]     @relation("CompetitionOwner")
  competitions     CompetitionUser[]
  picks            Pick[]
  favoriteTeams    FavoriteTeam[]
  payments         Payment[]
  notifications    Notification[]
}

model Competition {
  id          String             @id @default(cuid())
  name        String
  description String?
  entryFee    Float              @default(0)
  prizePool   Float              @default(0)
  inviteCode  String?            @unique
  startDate   DateTime
  endDate     DateTime
  isPublic    Boolean            @default(true)
  maxEvents   Int                @default(50)
  status      String             @default("upcoming")
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  ownerId     String
  owner       User               @relation("CompetitionOwner", fields: [ownerId], references: [id])
  events      CompetitionEvent[]
  users       CompetitionUser[]
  payments    Payment[]
  picks       Pick[]
}

model CompetitionUser {
  id            String      @id @default(cuid())
  userId        String
  competitionId String
  score         Int         @default(0)
  rank          Int?
  role          String      @default("member")
  joinedAt      DateTime    @default(now())
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id])

  @@unique([userId, competitionId])
}

model Event {
  id           String             @id @default(cuid())
  eventNumber  Int?
  title        String?
  sport        String
  options      Json?
  team1Name    String?
  team1Abbr    String?
  team1Odds    String?
  team2Name    String?
  team2Abbr    String?
  team2Odds    String?
  eventDate    DateTime
  status       String             @default("upcoming")
  winner       String?
  score        String?
  externalId   String?            @unique
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  competitions CompetitionEvent[]
  picks        Pick[]
  oddsSnapshots OddsSnapshot[]
}

model CompetitionEvent {
  id            String      @id @default(cuid())
  competitionId String
  eventId       String
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([competitionId, eventId])
}

model Pick {
  id            String      @id @default(cuid())
  userId        String
  eventId       String
  competitionId String
  selectedTeam  String
  isCorrect     Boolean?
  points        Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id])
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId, competitionId])
}

model FavoriteTeam {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sport     String
  team      String
  createdAt DateTime @default(now())

  @@unique([userId, sport, team])
  @@index([userId])
}

// Payment tracking for competition entry fees
model Payment {
  id              String      @id @default(cuid())
  userId          String
  competitionId   String
  amount          Float
  currency        String      @default("AUD")
  status          String      @default("pending")
  stripePaymentId String?     @unique
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  competition     Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([competitionId])
}

// Odds snapshots for market mover tracking
model OddsSnapshot {
  id        String   @id @default(cuid())
  eventId   String
  team      String
  odds      Float
  source    String   @default("the-odds-api")
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, createdAt])
}

// User notifications and alerts
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}
